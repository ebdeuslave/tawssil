import requests
import json
from bs4 import BeautifulSoup
from __auth__ import *


class Tawssil:
    def __init__(self, username, password) -> None:
        self.username = username
        self.password = password
        
    @property
    def session(self) -> requests.Session:
        sess = requests.Session()
        front = sess.get("https://portail.tawssil.ma/web")
        soup = BeautifulSoup(front.text, 'html.parser')
        csrf_token = soup.find('input', {'name': 'csrf_token'})['value'] 
        
        payload = {
            "csrf_token": csrf_token,
            "login": self.username,
            "password": self.password,
        }

        sess.post("https://portail.tawssil.ma/web/login", data=payload, cookies=sess.cookies)

        return sess
               
               
    def getPackages(self, limit=80):
        if limit > 80:
            raise Exception("Limit should not be > 80")
        
        OFFSET = 0 # must be fixed to 0 to begin from the 1st page
        packages = {
            "total": 0,
            "list": []
        }
        
        for _ in range(0, 1000):
            json_data = {
                'jsonrpc': '2.0',
                'method': 'call',
                'params': {
                    'model': 'cp.coli',
                    'domain': [],
                    'fields': [
                        'name',
                        'barcode',
                        'partner_barcode',
                        'ref_colis',
                        'create_date',
                        'partner_id',
                        'child_name',
                        'ship_from_city',
                        'ship_to_city',
                        'shipment_type',
                        'currency_id',
                        'is_return',
                        'partner_type',
                        'fees',
                        'cod',
                        'is_crbt_client_paid',
                        'state',
                        'statut',
                        'return_reason',
                    ],
                    'offset': OFFSET, # offset means "start from x+1 to limit, Ex: if offset=0 and limit=80 result will be from 1-80, offset=80 result: 81-160...etc"
                    'limit': limit, # max limit = 80
                    'sort': '',
                    'context': {
                        'lang': 'fr_FR',
                        'tz': 'Africa/Casablanca',
                        'uid': 49117,
                        'allowed_company_ids': [
                            1,
                        ],
                        'bin_size': True,
                    },
                },
            }
            
            response = requests.post('https://portail.tawssil.ma/web/dataset/search_read', cookies=self.session.cookies, json=json_data)
            
            try:
                if not response.json()["result"]["length"]:
                    # if length is 0 means the last page was the previous
                    return packages
                
                packages["total"] += response.json()["result"]["length"]
                packages["list"].extend(response.json()["result"]["records"])
                              
            except:
                print(response.content)
                return
        
            OFFSET += limit # add limit X to offset to move to the next page
            
        return packages
            
            
    def savePackages(self, packages:list, filename="json_files/tawssil/tawssil_packages_backup.json"):
        with open(filename, "w", encoding="utf-8") as f:
            json.dump(packages["list"], f, ensure_ascii=False, indent=4)
        

    def getUserInfo(self, ids):
        json_data = {
            'jsonrpc': '2.0',
            'method': 'call',
            'params': {
                'args': [
                    ids,
                    [
                        'name',
                        'city',
                        'phone',
                        'email',
                        'website',
                        'api_secret_key',
                        'company_type'
                    ],
                ],
                'model': 'res.partner',
                'method': 'read',
                'kwargs': {},
            },
        }

        response = self.session.post('https://portail.tawssil.ma/web/dataset/call_kw/res.partner/read', cookies=self.session.cookies, json=json_data)
        
        try:   
            result = [ item for item in response.json()["result"] if item["name"] and item["city"] and item["phone"]]
            
            return result
        except:
            return response.content
     
        
tawssil = Tawssil(username, password)


def backupPackages():
    packages = tawssil.getPackages()
    tawssil.savePackages(packages)

backupPackages()

def getTawssilPartners():
    start, end = 1, 1000

    data = []
    
    for _ in range(1_000_000):
        if end > 300_000: break
        
        print(f"From {start} To {end}")
        
        users = tawssil.getUserInfo([id for id in range(start,end)])
        
        start+= 1001
        end+= 1000
        
        if not users:
            continue
        
        data.extend(users)
        
        with open("tawssil_partners.json", "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
            
    
    

    
    







